<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AutoPitch AI</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      :root { --bg:#0b0f19; --card:#121725; --text:#eef1f6; --muted:#9aa4b2; --brand:#6aa6ff; --warn:#ffb86b; }
      * { box-sizing: border-box; }
      body { background: var(--bg); color: var(--text); font-family: system-ui, Arial, sans-serif; }
      .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
      header { display:flex; align-items:center; justify-content:space-between; margin: 12px 0 24px; }
      .logo { display:flex; align-items:center; gap:10px; font-weight:700; }
      .logo .dot { width:12px; height:12px; border-radius:50%; background: var(--brand); display:inline-block; }
      .grid2 { display:grid; grid-template-columns: 2fr 1fr; gap: 16px; }
      .card { background: var(--card); border: 1px solid #222940; border-radius: 14px; padding: 16px; }
      textarea, select, button, input { width: 100%; font-size: 16px; color: var(--text); }
      textarea, select, input { background: #0e1322; border:1px solid #2a334b; border-radius: 10px; padding: 10px; }
      textarea { height: 140px; }
      label { display:block; margin: 8px 0 6px; font-weight:600; }
      .row { margin: 12px 0; }
      .grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
      .btn { background: var(--brand); border: none; border-radius: 10px; padding: 12px; font-weight:700; cursor:pointer; }
      .btn.warn { background: var(--warn); color: #1a1a1a; }
      .btn:disabled { filter: grayscale(0.6); opacity: 0.7; cursor:not-allowed; }
      .muted { color: var(--muted); font-size: 14px; }
      .results { display:grid; gap: 12px; margin-top: 16px; }
      .email { background: #0e1322; border:1px solid #2a334b; border-radius: 12px; padding: 12px; }
      .email h3 { margin:0 0 8px; font-size: 16px; }
      .actions { display:flex; gap:8px; margin-top:8px; }
      .actions button { flex:1; }
      .toolbar { display:flex; gap:8px; margin-top:12px; }
      .toolbar button { flex: 1; }
      .templates { display:grid; gap:8px; max-height: 520px; overflow:auto; }
      .tmpl { background:#0e1322; border:1px solid #2a334b; border-radius:10px; padding:10px; }
      .tmpl h4 { margin:0 0 6px; font-size: 15px; }
      .tmpl .small { color: var(--muted); font-size: 12px; }
      .tmpl .rowbtn { display:flex; gap:8px; margin-top:8px; }
      .paywall { background:#0e1322; border:1px dashed #2a334b; border-radius:10px; padding:12px; margin-top:12px; }
      .plans { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
      @media (max-width: 960px) { .grid2 { grid-template-columns: 1fr; } }
      footer { margin:24px 0; text-align:center; color:#9aa4b2; }
      footer a { color:inherit; text-decoration:none; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="logo"><span class="dot"></span> AutoPitch AI</div>
        <div class="muted" id="limits">Rate limit: —</div>
      </header>

      <div class="grid2">
        <div class="card">
          <p class="muted">Paste the job, your skills, choose tone + CTA, and how many variants to generate.</p>

          <div class="row">
            <label for="job">Job description</label>
            <textarea id="job" placeholder="Paste the client post or job details here..."></textarea>
          </div>

          <div class="row">
            <label for="skills">Your skills/services</label>
            <textarea id="skills" placeholder="Describe your services and strengths..."></textarea>
          </div>

          <div class="row grid">
            <div>
              <label for="tone">Tone</label>
              <select id="tone">
                <option>Friendly</option>
                <option>Formal</option>
                <option>Bold & Direct</option>
                <option>Conversational</option>
                <option>Persuasive</option>
              </select>
            </div>
            <div>
              <label for="cta">CTA style</label>
              <select id="cta">
                <option>Book a quick call</option>
                <option>Reply with details</option>
                <option>Get a free audit</option>
                <option>Schedule a demo</option>
                <option>Start with a trial</option>
              </select>
            </div>
            <div>
              <label for="variants">Variants</label>
              <select id="variants">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="go">Generate Emails</button>
          </div>

          <div id="status" class="muted"></div>
          <div class="toolbar" id="toolbar" style="display:none">
            <button class="btn" id="copyAll">Copy all</button>
            <button class="btn" id="downloadCsv">Download CSV</button>
          </div>

          <div class="results" id="results"></div>
        </div>

        <aside class="card">
          <h3 style="margin-top:0">Saved Templates</h3>
          <p class="muted">Click Save on any result to store it here.</p>
          <div class="templates" id="templates"></div>
          <div class="row" style="display:flex; gap:8px">
            <button class="btn" id="exportAll">Export all (.csv)</button>
            <button class="btn warn" id="clearAll">Clear all</button>
          </div>

          <div class="paywall" id="paywall" style="display:none">
            <strong>Upgrade for unlimited pitches</strong>
            <p class="muted">Choose a plan to unlock unlimited generations and faster models.</p>
            <div class="plans">
              <button class="btn" id="buyStd">Standard – $19/mo</button>
              <button class="btn" id="buyPro">Premium – $39/mo</button>
            </div>
          </div>
        </aside>
      </div>

      <footer>
        <a href="/terms">Terms</a> • <a href="/privacy">Privacy</a>
      </footer>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const go = $('go'), results = $('results'), statusEl = $('status'), limitsEl = $('limits');
      const toolbar = $('toolbar'), copyAllBtn = $('copyAll'), downloadCsvBtn = $('downloadCsv');
      const tmplList = $('templates'), exportAllBtn = $('exportAll'), clearAllBtn = $('clearAll');
      const paywall = $('paywall'), buyStdBtn = $('buyStd'), buyProBtn = $('buyPro');

      const FREE_MODE_MAX = 10;
      let freeCount = parseInt(localStorage.getItem('ap_free_count')||'0',10);
      let lastEmails = [];
      let checkoutEnabled = false;

      function emailText(e) { return `Subject: ${e.subject}\n\n${e.body}`; }
      function copyToClipboard(text, btn) { navigator.clipboard.writeText(text).then(() => { const old = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = old, 1200); }).catch(() => alert('Copy failed')); }
      function toCsv(rows) { const esc = (s='') => `"${String(s).replace(/"/g,'""')}"`; const header = ['subject','body']; const lines = [header.map(esc).join(',')]; rows.forEach(r => lines.push([esc(r.subject), esc(r.body)].join(','))); return lines.join('\r\n'); }
      function download(name, mime, data) { const blob = new Blob([data], { type: mime }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url); }

      function loadTemplates() {
        const arr = JSON.parse(localStorage.getItem('ap_templates')||'[]');
        tmplList.innerHTML = '';
        if (!arr.length) { tmplList.innerHTML = '<div class="muted">No saved templates yet.</div>'; return; }
        arr.forEach((t, i) => {
          const div = document.createElement('div');
          div.className = 'tmpl';
          div.innerHTML = `<h4>${t.subject||'(no subject)'}</h4><div class="small">Saved ${new Date(t.saved_at||Date.now()).toLocaleString()}</div><div style="margin-top:8px">${(t.body||'').replace(/\n/g,'<br>')}</div>`;
          const rowbtn = document.createElement('div'); rowbtn.className = 'rowbtn';
          const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='Copy';
          copyBtn.onclick = () => copyToClipboard(emailText(t), copyBtn);
          const dlBtn = document.createElement('button'); dlBtn.className='btn'; dlBtn.textContent='Download .txt';
          dlBtn.onclick = () => download((t.subject||'email').replace(/[\\\/:*?"<>|]+/g,'_') + '.txt', 'text/plain', emailText(t));
          const delBtn = document.createElement('button'); delBtn.className='btn warn'; delBtn.textContent='Delete';
          delBtn.onclick = () => {
            const arr2 = JSON.parse(localStorage.getItem('ap_templates')||'[]');
            arr2.splice(i,1);
            localStorage.setItem('ap_templates', JSON.stringify(arr2));
            loadTemplates();
          };
          rowbtn.appendChild(copyBtn); rowbtn.appendChild(dlBtn); rowbtn.appendChild(delBtn);
          div.appendChild(rowbtn);
          tmplList.appendChild(div);
        });
      }
      function saveTemplate(e) {
        const arr = JSON.parse(localStorage.getItem('ap_templates')||'[]');
        arr.unshift({ subject: e.subject||'', body: e.body||'', saved_at: Date.now() });
        localStorage.setItem('ap_templates', JSON.stringify(arr.slice(0,200)));
        loadTemplates();
      }

      copyAllBtn.onclick = () => { const text = lastEmails.map(emailText).join('\n\n---\n\n'); copyToClipboard(text, copyAllBtn); };
      downloadCsvBtn.onclick = () => { const csv = toCsv(lastEmails); download('autopitch_emails.csv', 'text/csv', csv); };
      exportAllBtn.onclick = () => {
        const arr = JSON.parse(localStorage.getItem('ap_templates')||'[]');
        if (!arr.length) return alert('No saved templates.');
        download('autopitch_templates.csv', 'text/csv', toCsv(arr));
      };
      clearAllBtn.onclick = () => {
        if (confirm('Delete all saved templates?')) {
          localStorage.removeItem('ap_templates');
          loadTemplates();
        }
      };

      async function refreshLimits() {
        try {
          const r = await fetch('/health');
          const j = await r.json();
          if (j?.rate_limit) { limitsEl.textContent = `Rate limit: ${j.rate_limit.max}/${Math.round(j.rate_limit.window_ms/1000)}s` + (j.model ? ` (model: ${j.model})` : ''); }
          checkoutEnabled = !!j?.checkout_enabled;
          if (freeCount >= FREE_MODE_MAX && checkoutEnabled) paywall.style.display = 'block'; else paywall.style.display = 'none';
        } catch {}
      }

      async function startCheckout(plan) {
        try {
          const r = await fetch('/checkout', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ plan }) });
          const j = await r.json();
          if (j?.url) { window.location.href = j.url; return; }
          alert(j?.error || 'Checkout not available.');
        } catch (e) { alert('Checkout error: ' + e.message); }
      }

      async function generate() {
        const job = $('job').value.trim();
        const skills = $('skills').value.trim();
        const tone = $('tone').value.trim();
        const ctaStyle = $('cta').value.trim();
        const variants = parseInt($('variants').value, 10) || 1;
        if (!job || !skills) { alert('Please fill both fields.'); return; }

        if (freeCount >= FREE_MODE_MAX) {
          if (checkoutEnabled) { paywall.style.display = 'block'; }
          else { alert('Free limit reached. Please try again later.'); }
          return;
        }

        statusEl.textContent = 'Generating...';
        results.innerHTML = '';
        toolbar.style.display = 'none';
        go.disabled = true;
        lastEmails = [];

        try {
          const res = await fetch('/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ job, skills, tone, ctaStyle, variants }) });
          const data = await res.json();
          if (!res.ok) { statusEl.textContent = 'Error: ' + (data?.error || res.status); console.error(data); return; }

          const emails = Array.isArray(data.emails) ? data.emails : [];
          if (!emails.length) { statusEl.textContent = 'No emails returned. Try again.'; return; }

          lastEmails = emails;
          statusEl.textContent = `Generated ${emails.length} variant(s).`;
          toolbar.style.display = 'flex';
          freeCount += 1; localStorage.setItem('ap_free_count', String(freeCount));

          emails.forEach((e, i) => {
            const card = document.createElement('div');
            card.className = 'email';
            card.innerHTML = `<h3>Variant ${i+1}: ${e.subject || '(no subject)'}</h3><div>${(e.body || '').replace(/\n/g, '<br>')}</div>`;
            const actions = document.createElement('div'); actions.className = 'actions';
            const copyBtn = document.createElement('button'); copyBtn.className = 'btn'; copyBtn.textContent = 'Copy';
            copyBtn.onclick = () => copyToClipboard(emailText(e), copyBtn);
            const dlBtn = document.createElement('button'); dlBtn.className = 'btn'; dlBtn.textContent = 'Download .txt';
            dlBtn.onclick = () => download((e.subject||'email').replace(/[\\\/:*?"<>|]+/g,'_') + '.txt', 'text/plain', emailText(e));
            const saveBtn = document.createElement('button'); saveBtn.className = 'btn'; saveBtn.textContent = 'Save';
            saveBtn.onclick = () => saveTemplate(e);
            actions.appendChild(copyBtn); actions.appendChild(dlBtn); actions.appendChild(saveBtn);
            card.appendChild(actions);
            results.appendChild(card);
          });
        } catch (err) {
          statusEl.textContent = 'Network error: ' + err.message;
        } finally { go.disabled = false; }
      }

      go.addEventListener('click', generate);
      (document.getElementById('buyStd')||{}).onclick = () => startCheckout('standard');
      (document.getElementById('buyPro')||{}).onclick = () => startCheckout('premium');

      loadTemplates();
      refreshLimits();
    </script>
  </body>
</html>
