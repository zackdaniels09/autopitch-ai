<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoPitch AI</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1224; --bg2:#0e1630; --card:#111a38; --ink:#eaf0ff; --muted:#a3b1d6;
      --accent:#3b82f6; --accent-ink:#0b1224; --border:#1b2550;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--ink)}
    header{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(11,18,36,.7);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .brand{font-weight:700;letter-spacing:.2px}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#18224a;border:1px solid var(--border);color:var(--muted)}
    .shell{max-width:1200px;margin:0 auto;padding:18px 16px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    label{display:block;margin:10px 0 6px;font-weight:600;color:var(--muted)}
    textarea,input,select{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px;background:#0c1533;color:var(--ink)}
    textarea{resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.row{grid-template-columns:1fr}}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .btn{border:1px solid var(--accent);background:var(--accent);color:var(--accent-ink);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--ink);border-color:var(--border)}
    .hint{font-size:12px;color:var(--muted)}
    .results{display:grid;gap:12px}
    .card{background:#0c1533;border:1px solid var(--border);border-radius:12px;padding:12px}
    .card pre{white-space:pre-wrap;margin:0}
    .price-card{background:#0c1533;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .price-title{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
    .price{font-weight:800}
    .bullets{margin:0;padding-left:18px;color:var(--muted)}
    .bullets li{margin:4px 0}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0a1228;color:#eaf0ff;border:1px solid var(--border);padding:10px 14px;border-radius:10px;display:none;z-index:60}
  </style>
  <script defer src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
</head>
<body>
  <header>
    <div class="brand">AutoPitch AI</div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="modelTag" class="tag">Model: gpt-4o-mini</div>
      <div id="planTag" class="tag">Plan: checking…</div>
    </div>
  </header>

  <div class="shell">
    <div class="grid">
      <div class="panel">
        <p class="hint">Free: 5/day & 1 variant. Premium: up to 3 variants and priority generation.</p>

        <label>Job post</label>
        <textarea id="jobPost" rows="8" placeholder="Paste job description…"></textarea>

        <div class="row">
          <div>
            <label>Your skills</label>
            <textarea id="skills" rows="6" placeholder="e.g., React, Node, 5+ years B2B SaaS…"></textarea>
          </div>
          <div>
            <label>Tone</label>
            <input id="tone" placeholder="e.g., concise & friendly" />
            <label>Call to action</label>
            <input id="cta" placeholder="e.g., short intro call this week?" />
            <label>Variants (premium up to 3)</label>
            <select id="variants"><option>1</option><option>2</option><option>3</option></select>
          </div>
        </div>

        <div class="actions">
          <button id="go" class="btn">Generate</button>
          <button id="clear" class="btn secondary">Clear</button>
        </div>

        <div id="results" class="results"></div>

        <div id="captchaWrap" style="display:none;margin-top:12px;">
          <div class="hint">Please complete the check to continue:</div>
          <div class="cf-turnstile" data-sitekey="" data-callback="onTurnstileOK"></div>
        </div>
      </div>

      <aside class="panel">
        <div class="price-card">
          <div class="price-title"><div><strong>Standard</strong></div><div class="price">$19.99/mo</div></div>
          <ul class="bullets">
            <li>Up to 300 emails/month</li>
            <li>Tone & CTA controls</li>
            <li>1–3 variants per prompt</li>
            <li>Save, copy, CSV export</li>
            <li>Template library</li>
            <li>Email support (24–48h)</li>
          </ul>
          <button id="buyStd" class="btn secondary">Subscribe to Standard</button>
        </div>

        <div class="sep"></div>

        <div class="price-card">
          <div class="price-title"><div><strong>Premium</strong></div><div class="price">$39.99/mo</div></div>
          <ul class="bullets">
            <li>Unlimited emails</li>
            <li>Priority generation</li>
            <li>1–3 variants per prompt</li>
            <li>Save, copy, CSV export</li>
            <li>Extended templates</li>
            <li>Same-day priority support</li>
            <li>Early access features</li>
          </ul>
          <button id="buyPro" class="btn">Subscribe to Premium</button>
        </div>

        <div class="sep"></div>

        <button id="manage" class="btn secondary">Manage billing</button>
      </aside>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const MAX_FREE = 5;
    let turnstileToken = null;
    window.onTurnstileOK = (token) => { turnstileToken = token; document.getElementById('captchaWrap').style.display='none'; };

    function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.style.display='none',3800); }

    async function me(){ try{ const r=await fetch('/me',{credentials:'include'}); return r.json(); }catch{ return {premium:false}; } }
    async function health(){ try{ const r=await fetch('/health'); return r.json(); }catch{ return {}; } }

    async function generate(){
      const jobPost = jobPostEl.value.trim();
      const skills  = skillsEl.value.trim();
      const tone    = toneEl.value.trim() || 'concise & friendly';
      const cta     = ctaEl.value.trim()  || 'short intro call this week?';
      const variants= Number(variantsEl.value);
      const body = { jobPost, skills, tone, cta, variants, turnstileToken };
      const res  = await fetch('/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),credentials:'include'});
      if(res.status===401){ toast('Please complete the check and try again.'); captchaWrap.style.display='block'; return; }
      if(res.status===402){ const j=await res.json().catch(()=>({})); toast(j.message||`You’ve hit today’s free limit (${MAX_FREE}). Upgrade to continue.`); return; }
      if(!res.ok){ toast('Generation failed. Try again.'); return; }
      const data = await res.json(); results.innerHTML='';
      (data.emails||[]).forEach((txt,i)=>{ const card=document.createElement('div'); card.className='card';
        const pre=document.createElement('pre'); pre.textContent=txt;
        const row=document.createElement('div'); row.className='actions';
        const b1=document.createElement('button'); b1.className='btn secondary'; b1.textContent='Copy';
        b1.onclick=async()=>{ await navigator.clipboard.writeText(txt); toast('Copied.'); };
        const b2=document.createElement('button'); b2.className='btn secondary'; b2.textContent='Download .txt';
        b2.onclick=()=>{ const blob=new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`email-${i+1}.txt`; a.click(); };
        row.append(b1,b2); card.append(pre,row); results.append(card); });
    }

    async function startCheckout(plan){
      try{
        const r = await fetch('/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({plan}),credentials:'include'});
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.url) throw new Error(j.message||j.error||'Checkout failed.');
        location.href=j.url;
      }catch(err){ toast(err.message||'Checkout failed.'); }
    }
    async function openPortal(){
      const email = prompt('Enter your billing email:'); if(!email) return;
      const r = await fetch('/portal',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email}),credentials:'include'});
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.url) return toast('Portal unavailable.');
      location.href=j.url;
    }

    // elements
    const jobPostEl=document.getElementById('jobPost');
    const skillsEl=document.getElementById('skills');
    const toneEl=document.getElementById('tone');
    const ctaEl=document.getElementById('cta');
    const variantsEl=document.getElementById('variants');
    const results=document.getElementById('results');
    const captchaWrap=document.getElementById('captchaWrap');

    document.getElementById('go').onclick=generate;
    document.getElementById('clear').onclick=()=>{ results.innerHTML=''; };
    document.getElementById('buyStd').onclick=()=>startCheckout('standard');
    document.getElementById('buyPro').onclick=()=>startCheckout('premium');
    document.getElementById('manage').onclick=openPortal;

    (async()=>{
      const h=await health();
      document.getElementById('modelTag').textContent = `Model: ${h.model||'gpt-4o-mini'}`;
      if(h && h.has_turnstile && h.turnstile_site_key){ document.querySelector('.cf-turnstile').setAttribute('data-sitekey', h.turnstile_site_key); }
      const m=await me(); document.getElementById('planTag').textContent=`Plan: ${m.premium?'premium':'free'}`;
    })();
  </script>
</body>
</html>